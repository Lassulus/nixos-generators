#!/usr/bin/env bash
set -euo pipefail

## Configuration

libexec_dir=$(dirname "$0")
configuration_path=${NIX_CONFIG:-./config.nix}
format_dir=$libexec_dir/formats
format_path=

## Functions

abort() {
  echo "$*" >&2
  exit 1
}

## Main ##

while [[ $# -gt 0 ]]; do
  case "$1" in
    --configuration)
      configuration_path=$2
      shift
      shift
      ;;
    --format)
      format_path=$format_dir/$2.nix
      shift
      shift

      if [[ ! -e $format_path ]]; then
        abort "format $format_path not found"
      fi

      ;;
    *)
      abort "unknown option $1"
      ;;
  esac
done

if [[ -z $format_path ]]; then
  abort "missing format"
fi

args=(
  "$libexec_dir/eval-format.nix"
  --arg configuration "$configuration_path"
  --arg formatConfig "$format_path"
)

formatAttr=$(nix-instantiate "${args[@]}" --eval --json -A config.formatAttr | jq -r .)

out=$(nix-build "${args[@]}" --no-out-link -A "config.system.build.$formatAttr")

echo "$out"/*
